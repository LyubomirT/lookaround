<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image to 3D Panorama</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: row;
        }
        .sidebar {
            width: 20%;
            height: 100%;
            background-color: #f0f0f0;
            overflow-y: auto;
            padding: 10px;
        }
        .main {
            width: 60%;
            height: 100%;
            background-color: #e0e0e0;
            overflow-y: auto;
            padding: 10px;
        }
        .preview {
            width: 20%;
            height: 100%;
            background-color: #d0d0d0;
            overflow-y: auto;
            padding: 10px;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        p {
            font-size: 16px;
            margin-bottom: 10px;
        }
        label {
            font-size: 14px;
            font-weight: normal;
        }
        input[type=file] {
            display: block;
            margin-bottom: 10px;
        }
        button {
            display: block;
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-info {
            background-color: #17a2b8;
        }
        .btn-info:hover {
            background-color: #138496;
        }
        img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Image to 3D Panorama</h1>
            <p>Upload an image of any size and create a 3D panorama of it.</p>
            <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
                <label for="image">Select an image:</label>
                <input type="file" id="image" name="image" accept="image/*" required>
                <button type="submit" class="btn-primary">Upload</button>
            </form>
            <hr>
            <label for="quality-slider">Texture Quality:</label>
            <input type="range" id="quality-slider" min="1" max="100" value="100">
            <hr>
            <label for="camera-speed">Camera Speed:</label>
            <input type="number" id="camera-speed" value="1">
            <hr>
        </div>
        <div class="main">
            {% if filename %}
            <div id="panorama-container">
                <p>Here is your 3D panorama. You can use your mouse to rotate and zoom in/out.</p>
                <div id="panorama-wrapper" style="width: 100%; height: 80%;"></div>
                <button id="fullscreen" class="btn-info">Fullscreen</button>
            </div>
            {% else %}
            <p>No image uploaded yet.</p>
            {% endif %}
        </div>
        <div class="preview">
            {% if filename %}
            <p>Here is your uploaded image:</p>
            <img src="{{ url_for('static', filename='uploads/' + filename) }}" alt="Uploaded image">
            <p>Click the button below to create a 3D panorama of it:</p>
            <button id="create-panorama" class="btn-success">Create 3D Panorama</button>
            {% else %}
            <p>No image preview available.</p>
            {% endif %}
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="{{ url_for('static', filename='js/OrbitControls.js') }}"></script>
    <script>
        // Validate the file size and type before uploading
        $(document).ready(function() {
            $('#upload-form').submit(function(e) {
                var file = $('#image')[0].files[0];
                var maxSize = 10 * 1024 * 1024; // 10 MB
                var allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (file.size > maxSize) {
                    alert('The file is too large. Please select a file smaller than 10 MB.');
                    e.preventDefault();
                }
                if (!allowedTypes.includes(file.type)) {
                    alert('The file type is not supported. Please select a JPEG, PNG, or GIF image.');
                    e.preventDefault();
                }
            });
        });

        // Create a 3D panorama of the image using WebGL and Three.js
        $(document).ready(function() {
            $('#create-panorama').click(function() {
                // Hide the button and show the panorama container
                $('#panorama-container').show();

                // Clear existing panorama
                $('#panorama-wrapper').empty();

                // Get the image source
                var image = $('img')[0];
                var src = image.src;

                // Create a scene, a camera, and a renderer
                var scene = new THREE.Scene();
                var camera = new THREE.PerspectiveCamera(75, 800 / 600, 0.1, 1000);
                var renderer = new THREE.WebGLRenderer();
                // Totally Responsive Size  
                renderer.setSize(800, 600);
                var panoramaWrapper = document.getElementById('panorama-wrapper');
                panoramaWrapper.appendChild(renderer.domElement);

                // Create a sphere geometry
                var geometry = new THREE.SphereGeometry(500, 60, 40);
                geometry.scale(-1, 1, 1); // Invert the sphere
                
                // Create a texture from the image with quality settings
                var quality = $('#quality-slider').val() / 100;
                var texture = new THREE.TextureLoader().load(src);
                texture.repeat.set(quality, quality);
                var material = new THREE.MeshBasicMaterial({map: texture});

                // Create a mesh from the geometry and the material
                var mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                // Create an orbit control to enable mouse interaction
                var controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableZoom = true;
                controls.enablePan = false;
                controls.minDistance = 100;
                controls.maxDistance = 900;

                // Set the camera position and look at the center
                camera.position.set(0, 0, 0);
                camera.lookAt(scene.position);

                // Function to handle window resize
                function onWindowResize() {
                    camera.aspect = panoramaWrapper.offsetWidth / panoramaWrapper.offsetHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(panoramaWrapper.offsetWidth, panoramaWrapper.offsetHeight);
                }
                window.addEventListener('resize', onWindowResize);

                // Render the scene
                var animate = function() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();
            });

            // Toggle the fullscreen mode
            $('#fullscreen').click(function() {
                var element = $('#panorama-wrapper')[0];
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            });
        });
    </script>
</body>
</html>

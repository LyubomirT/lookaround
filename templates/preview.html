<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image to 3D Panorama</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container">
        <h1>Image to 3D Panorama</h1>
        <p>Here is your uploaded image:</p>
        <img src="{{ url_for('static', filename='uploads/' + filename) }}" alt="Uploaded image" class="img-fluid">
        <p>Click the button below to create a 3D panorama of it:</p>
        <button id="create-panorama" class="btn btn-success">Create 3D Panorama</button>
        <div id="panorama-container" style="display: none;">
            <p>Here is your 3D panorama. You can use your mouse to rotate and zoom in/out.</p>
            <div id="panorama" style="width: 800px; height: 600px;"></div>
            <button id="fullscreen" class="btn btn-info">Fullscreen</button>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="{{ url_for('static', filename='js/OrbitControls.js') }}"></script>
    <script>
        // Create a 3D panorama of the image using WebGL and Three.js
        $(document).ready(function() {
            $('#create-panorama').click(function() {
                // Hide the button and show the panorama container
                $(this).hide();
                $('#panorama-container').show();

                // Get the image source
                var image = $('img')[0];
                var src = image.src;

                // Create a scene, a camera, and a renderer
                var scene = new THREE.Scene();
                var camera = new THREE.PerspectiveCamera(75, 800 / 600, 0.1, 1000);
                var renderer = new THREE.WebGLRenderer();
                renderer.setSize(800, 600);
                document.getElementById('panorama').appendChild(renderer.domElement);

                // Create a sphere geometry and a texture from the image
                var geometry = new THREE.SphereGeometry(500, 60, 40);
                geometry.scale(-1, 1, 1); // Invert the sphere
                var texture = new THREE.TextureLoader().load(src);
                var material = new THREE.MeshBasicMaterial({map: texture});

                // Create a mesh from the geometry and the material
                var mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                // Create an orbit control to enable mouse interaction
                var controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableZoom = true;
                controls.enablePan = false;
                controls.minDistance = 100;
                controls.maxDistance = 900;

                // Set the camera position and look at the center
                camera.position.set(0, 0, 0);
                camera.lookAt(scene.position);

                // Render the scene
                var animate = function() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();
            });

            // Toggle the fullscreen mode
            $('#fullscreen').click(function() {
                var element = $('#panorama')[0];
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            });
        });
    </script>
</body>
</html>
